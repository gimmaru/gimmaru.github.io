---
layout: post
title:  "[Designing Machine Learning Systems] MLOps를 위한 인프라와 도구"
subtitle:   "부제"
categories: study
tags: mlops
comments: true

---

ML 시스템에 적합한 인프라를 설정하는 방법을 알아본다.

본론으로 들어가기에 앞서 주의할 점은 회사마다 인프라 요구 사항이 다르다는 점이다. 가령 간단한 ML 유스 케이스 하나만 있는 경우에는 인프라가 크게 필요하지 않다. 텐서플로 라이트 같은 안드로이드 호환 ML 프레임워크만 있으면 된다.

ML 세계에서 인프라란 ML 시스템의 개발과 유지 관리를 지원하는 기본 시설의 집합이다. 이 절에서는 다음 네 가지 레이어를 살펴본다.

#### 스토리지와 컴퓨팅

스토리지 레이어에서는 데이터가 수집되고 저장되며, 컴퓨팅 레이어는 모델 훈련, 피처 연산, 피처 생성 등 ML 워크로드를 실행하는 데 필요한 연산 자원을 제공한다.

#### 자원 관리

사용 가능한 연산 자원을 최대한 활용할 수 있도록 워크로드 일정을 수립하고 오케스트레이션하는 도구로 구성된다. 이 범주에 속하는 도구의 예로는 에어플로, 쿠브플로, 메타플로가 있다.

#### ML 플랫폼

모델 스토어, 피처 스토어, 모니터링 도구 같은 ML 애플리케이션 개발을 위한 도구를 제공한다. 이 범주에 속하는 도구의 예로는 세이지메이커와 ML플로가 있다.

#### 개발 환경

일반적으로 코드가 작성되고 실험이 실행되는 곳이다. 코드는 버전 관리 및 테스트가 수행돼야 하며 실험을 추적돼야 한다.

무엇을 직접 구축하고 무엇을 다른 회사에서 구매하는지에 따라 결과로 만들어지는 인프라는 매우 다를 수 있다. 두 접근법에 관한 의사 결정을 논의하고, 표준화되고 통합된 ML 인프라 추상화에 대한 바람 또한 논의한다.

## 10.1 스토리지와 컴퓨팅

스토리지 레이어는 데이터가 수집되고 저장되는 곳으로, 가장 단순한 형태는 HDD나 SSD이다.

데이터 스토리지는 매우 저렴해져 대부분의 회사에서 거의 비용 지출 없이 보유한 데이터를 모두 저장한다. [3장](https://gimmaru.github.io/study/2023/12/26/study-mlops-designing_ml_systems_3/)에서 데이터 레이어를 깊게 다뤘다.

컴퓨팅 레이어는 회사가 접근할 수 있는 모든 연산 자원과 그 사용법을 결정하는 매커니즘이다. 사용 가능한 연산 자원의 양은 워크로드 확장성을 결정한다. 어떤 작업을 실행하는 엔진으로 볼 수 있으며 가장 단순한 형태는 모든 연산을 수행하는 단일 CPU 코어 혹은 GPU 코어이다. 가장 흔한 형태는 EC2나 GCP와 같이 클라우드 공급업체가 관리하는 클라우드 컴퓨팅이다.

컴퓨팅 레이어를 보통 더 작은 연산 유닛으로 분할할 수 있으며, 유닛들을 동시에 사용할 수 있다. (CPU 코어의 스레드, 혹은 여러 CPU 코어 사용)

컴퓨팅 레이어가 항상 스레드나 코어를 연산 유닛으로 사용하지는 않는다. 코어 개념을 추상화해 다른 연산 유닛을 사용하는 컴퓨팅 레이어도 있다. (ex. 스파크, 레이, 쿠버네티스)

작업을 실행하려면 먼저 필요한 데이터를 연산 유닛 메모리에 적재한 다음 해당 데이터에서 필요한 연산(덧셈, 곰셈, 나눗셈, 합성곱 등)을 실행해야 한다. 따라서 연산 유닛을 특징지을 때는 주로 메모리 크기와 작업 실행 속도라는 두 가지 지표를 사용한다.

메모리 지표는 기가바이트 같은 단위로 지정하며 평가는 대개 단순하다. 일부 회사에서는 연산 유닛의 메모리 크기뿐 아니라 데이터를 메모리 안팎으로 적재하는 속도 또한 중요시한다.

작업 속도에 대한 일반적인 지표는 FLOPS로 연산 유닛이 초당 실행 가능한 부동 소수점 작업 수를 의미한다.

이 지표는 다음과 같은 이유로 논쟁의 여지가 있다.

1. 회사에 따라 무엇을 작업으로 간주할지
2. 연산 유닛이 1조 FLOPS를 처리할 수 있다고 해서 1조 FLOPS 속도로 작업을 실행할 수 있다는 뜻은 아니다. (사용률 100%를 달성하기는 거의 불가능하다.)

새로운 연산 유닛을 평가할 때는 해당 연산 유닛이 일반 워크로드를 수행하는 데 걸리는 시간을 평가하는 것이 중요하다(ex. [MLPerf 벤치마크](https://oreil.ly/XuVka)).

많은 사람이 연산 성능을 평가할 때 간단히 연산 유닛이 가진 코어 개수만 살펴본다.

### 10.1.1 퍼블릿 클라우드 vs. 프라이빗 데이터 센터

클라우드 컴퓨팅을 사용하면 기업에서 컴퓨팅 레이어를 크게 걱정할 필요 없이 개발을 매우 쉽게 시작할 수 있다. 이는 워크로드 크기가 유동적인 회사에게 특히 매력적이다(워크로드에 연중 딱 하루만 1,000개의 CPU 코어가 필요하고 나머지는 10개만 필요하다면?).

클라우드 컴퓨팅은 탄력적이지만 마술은 아니다. 대부분의 클라우드 공급업체는 한 번에 사용할 수 있는 연산 자원에 제한을 둔다. 연산 자원이 많다고 항상 사용하기 쉬운 것은 아니다. 특히 비용 절약을 위해 스팟 인스턴스로 작업해야 하는 경우에는 더욱 어렵다.

클라우드를 사용하는 초기에는 스토리지와 컴퓨팅 레이어를 직접 구축할 때보다 수익이 더 높은 경향이 있지만 기업이 성장함에 따라 수익 방어가 어려워진다. -> 클라우드 송환 발생

클라우드를 시작하기는 쉬워도 벗어나기는 어렵다. 점점 더 많은 기업이 하이브리드 접근 방식을 따르고 있다. 워크로드의 대부분을 클라우드에 유지하면서 데이터 센터에 대한 투자를 천천히 늘린다.

\+ 멀티클라우드 전략: 단일 클라우드 공급업체에 대한 의존을 줄이는 전략, 워크로드를 여러 클라우드 공급업체에 분산한다. 클라우드 간에 데이터를 이동하고 워크로드를 오케스트레이션하는 일은 매우 어렵기 때문에 보통 의사 결정에 따라 발생하는 일은 아니다.

## 10.2 개발 환경

개발 환경은 엔지니어가 작업하는 곳이므로 개발 환경이 개선되면 엔지니어링 생산성 또한 개선된다.

개발 환경의 여러 구성 요소를 알아보고 개발 환경의 표준화를 논의한 뒤 컨테이너를 사용해 개발 환경의 변경 사항을 프로덕션 환경으로 가져오는 방법을 알아봅니다.

### 10.2.1 개발 환경 설정

#### IDE

코드를 작성하는 편집기, 보통 여러 프로그래밍 언어를 지원한다.

노트북은 IDE는 아니지만 유용하다. 그 중 상태 유지 속성은 데이터셋을 한 번 적재한 후 계속 사용할 수 있게 도와주기에 매우 편리하지만, 셀은 순서대로 실행하지 않아도 되기에 재현성 유지를 까다롭게 한다.

넷플릭스의 중요한 블로그 글 ['인터랙티브를 넘어서: 넷플릭스의 노트북 혁신'](https://netflixtechblog.com/notebook-innovation-591ee3221233)에는 노트북을 더욱 강력하게 만드는 데 사용할 수 있는 인프라 도구 목록이 있다(페이퍼밀, 커뮤터가 포함되어 있다).

노트북 경험 개선을 목표로 하는 또 다른 흥미로운 프로젝트로 [nbdev](https://nbdev.fast.ai)가 있다.

### 10.2.2 개발 환경 표준화

개발 환경에 대한 첫 번째 준칙은 표준화돼야 한다는 점이다.

도구와 패키지를 표준화해야 한다는 데는 대체로 동의하지만 일부 회사는 IDE 표준화에 주저한다.

로컬 개발 환경에서 클라우드 개발 환경으로 이동했을 때 이점

1. IT 지원이 훨씬 쉬워진다.
2. 원격 작업이 편리해진다.
3. 클라우드 개발 환경이 보안에 도움이 될 수 있다. (일부 기업은 보안 문제 때문에 클라우드 개발 환경으로 이전하기를 꺼린다. 코드나 데이터를 보관하는 것을 꺼린다.)
4. 개발 환경과 프로덕션 환경 간의 차이를 줄일 수 있다.

비용과 보안을 비롯한 문제가 있기에 모든 회사에 적합하지는 않다.

한편, 개발 환경의 표준화는 데이터 과학자의 삻을 보다 윤택하게 해주며 장기적으로 비용을 줄여준다.

### 10.2.3 개발 환경에서 프로덕션 환경으로: 컨테이너

개발 중에는 워크로드가 크게 변동하지 않는다. 따라서 작업하는 머신 또는 인스턴스 개수는 일반적으로 고정돼 있다.

프로덕션 서비스는 여러 인스턴스에 분산돼 있을 수 있다. 인스턴스 수는 유입되는 워크로드에 따라 수시로 바뀌며, 이는 때때로 예측 불가능하다.

프로덕션 환경에 필요에 따라 인스턴스를 동적 할당하는 경우 환경은 본질적으로 무상태이다. 워크로드에 신규 인스턴스가 할당되면 사전에 미리 정의한 지침 목록을 사용해 종속성을 설치해야 한다.

신규 인스턴스에서 환경을 어떻게 재생성할까? 도커로 가장 유명한 컨테이너 기술은 이 질문에 답하기 위해 만들어졌다.

도커의 핵심 개념 두 가지는 이미지와 컨테이너이다. 도커 파일은 도커 이미지라는 틀을 제조하는 레시피로 볼 수 있다. 이 틀을 사용해 실행되는 인스턴스를 여러 개 찍어낼 수 있다. 각각이 도커 컨테이너이다.

도커 이미지는 밑바닥부터 혹은 다른 도커 이미지로부터 빌드할 수 있다.

컨테이너 레지스트리는 도커 이미지를 공유하거나, 다른 사람이 만든 이미지를 찾아 공개적으로 혹은 조직 내부 사람들과 공유할 수 있는 장소이다.

애플리케이션이 작업을 수행하는 동안 컨테이너가 두 개 이상 필요할 수 있다.

파이프라인의 여러 단계 간에 종속성이 충돌할 때도 서로 다른 컨테이너가 필요할 수 있다.

여러 컨테니어를 관리하는 데 도움이 되는 도구를 컨테이너 오케스트레이션이라고 한다. 도커 컴포즈는 단일 호스트에서 컨테이너를 관리할 수 있는 경량 컨테이너 오케스트레이터이다.

각 컨테이너가 자체 호스트에서 실행될 수 있으며 이때 도커 컴포즈는 한계가 있다. 쿠버네트스(K8s)는 바로 이것을 위한 도구이다. 컨테이너 간에 통신하고 자원을 공유하는 네트워크를 만들어준다.

다만 데이터 과학자에게 친화적인 도구가 아니며, K8s에 대한 직접적인 접근 없이 데이터 과학 워크로드를 다룰 방법에 대해 많은 논의가 있었다.

## 10.3 자원 관리

